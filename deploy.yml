- name: Deploy on EC2
  runs-on: ubuntu-latest
  needs: [build_createpost, build_getpost, build_updatepost, build_deletepost]

  steps:
    - name: Set up SSH Key
      run: |
        mkdir -p ~/.ssh
        echo "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/id_rsa
        chmod 600 ~/.ssh/id_rsa
        ssh-keyscan -H ${{ secrets.EC2_PUBLIC_IP }} >> ~/.ssh/known_hosts

    - name: Test SSH Connection
      run: ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_PUBLIC_IP }} "echo 'SSH Connection Successful'"

    - name: Deploy Docker Containers on EC2
      env:
        AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
        AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        AWS_REGION: "us-east-1"
        DYNAMODB_TABLE: "PostsTable"
        S3_BUCKET: "distribuidabucketsocial"
      run: |
        ssh -o StrictHostKeyChecking=no -i ~/.ssh/id_rsa ec2-user@${{ secrets.EC2_PUBLIC_IP }} << 'EOF'
          set -e
          echo "Stopping and removing existing containers..."
          sudo docker-compose down || true

          echo "Pulling latest images..."
          sudo docker-compose pull

          echo "Exporting environment variables..."
          export AWS_ACCESS_KEY_ID=${{ secrets.AWS_ACCESS_KEY_ID }}
          export AWS_SECRET_ACCESS_KEY=${{ secrets.AWS_SECRET_ACCESS_KEY }}
          export AWS_REGION="us-east-1"
          export DYNAMODB_TABLE="PostsTable"
          export S3_BUCKET="distribuidabucketsocial"

          echo "Starting services..."
          sudo docker-compose up -d
        EOF
